<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>排课管理</title>
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="http://apps.bdimg.com/libs/html5shiv/3.7/html5shiv.min.js"></script>
  <script src="http://apps.bdimg.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  <link rel="stylesheet" type="text/css"
    href="css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap-select.min.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="css/base.css">
  <link rel="stylesheet" type="text/css" href="css/head.css">
  <script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/jquery.cookie.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/bootstrap-select.min.js"></script>
  <script type="text/javascript" src="js/defaults-zh_CN.js"></script>
  <link rel="stylesheet" href="css/daterangepicker.css">
  <script src="js/moment.js"></script>
  <script src="js/daterangepicker.js"></script>
  <script src="js/bootstrap-paginator.min.js"></script>
  <script src="common/common.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" type="text/css" href="css/timetable.css?z=1">
  <style>
      .daterangepicker.single .ranges,
      .daterangepicker.single .calendar {
          float: none !important;
      }
  
      .daterangepicker .applyBtn.btn {
          background: rgb(51, 154, 255) !important;
          outline: none !important;
          border: none !important;
      }
  
      .daterangepicker .cancelBtn.btn {
          display: none;
      }
  
      .daterangepicker .applyBtn.btn {
          width: 243px;
          height: 32px;
          margin-right: 4px;
          margin-top: 6px;
      }
  
      .daterangepicker td.today,
      .daterangepicker td.today:hover {
          color: rgb(51, 154, 255) ;
          background: #F5F5F5;
      }
  
      .daterangepicker td.active,
      .daterangepicker td.active:hover {
          background: rgb(51, 154, 255) !important;
          color: #fff; 
      }
  
      .daterangepicker .calendar-table th,
      .daterangepicker .calendar-table td {
          height: 20px;
          line-height: 18px;
      }
  </style>
</head>

<body style="background: #fff;">
  <nav class="navbar" role="navigation" id="topnav">
    <div class="container-fluid">
      <ul class="nav navbar-nav" id="firstnav">
        <li class="js-list">
          <a href="index.html">首页</a>
        </li>
        <li class="js-list">
          <a href="timetable.html">排课管理</a>
        </li>
        <li class="js-list">
          <a href="classmanage.html">上课人员管理</a>
        </li>
        <li class="js-list isteacher">
          <a href="datastatis.html">数据统计</a>
        </li>
        <li class="js-list">
          <a href="course.html">课程管理</a>
        </li>
        <li class="js-list">
          <a href="student.html">学员管理</a>
        </li>
        <li class="js-list isteacher">
          <a href="doctor.html">医生管理</a>
        </li>
        <li class="js-list  isteacher">
          <a href="classroom.html">教室管理</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <img id="head-img" class="top-img" src="img/tmanager.png" title="个人信息"
            onclick="popModal('#modal_id','edit.html')"><span id="username"
            onclick="popModal('#modal_id','edit.html')">admin</span>
        </li>
        <li style="padding-left:12px;">
          <img class="top-img" src="img/info.png" onclick="popModal('#modal_id','subscribelist.html')"
            title="预约列表"><span class="badge" id="flags">4</span>
          <img class="top-img" src="img/shenhe.png" onclick="popModal('#modal_id','leave.html')" title="请假审核">
          <img class="top-img" src="img/tuichu.png" onclick="quit()" title="开关">
        </li>
      </ul>
    </div>
  </nav>
  <div class="containers" id="content">
    <div class="second-tap" style="position:relative;">
      <div class="select-tap" style="width:15%;display: inline-block;margin-left: 1%;">
        <!-- <div class="btn-group">
                      <p class="buttonText dropdown-toggle" data-toggle="dropdown">默认 <span class="caret"></span></p>
                  <ul class="dropdown-menu" role="menu">
                      <li><a href="#" onclick="shows($(this).text())">启蒙教室</a></li>
                      <li><a href="#" onclick="shows($(this).text())">多元教室</a></li>
                      <li><a href="#" onclick="shows($(this).text())">体能教室</a></li>
                      <li><a href="#" onclick="shows($(this).text())">音乐教室</a></li>
                      <li><a href="#" onclick="shows($(this).text())">蒙氏教室</a></li>
                      <li><a href="#" onclick="shows($(this).text())">育乐教室</a></li>
                  </ul>
              </div> -->
        <input type="hidden" name="selectId" class="form-control">
        <select class="selectpicker" icon-base="glyphicon" tick-icon="glyphicon-ok" id="selectRoom" name="selectRoom"
          style="text-align: center;">
          <!-- <option selected>启蒙教室</option>
          <option>多元教室</option>
          <option>体能教室</option>
          <option>音乐教室</option>
          <option>蒙氏教室</option>
          <option>育乐教室</option> -->
        </select>
      </div>
      <div class="center text-center" style="width:67%;display:inline-block;"><span
          class="menu-icon-left icon" onclick="time('-')"></span><span id='ym'>2018年09月</span><span
          class="menu-icon-right icon" onclick="time('+')"></span></div>
      <div class="select-tap text-right" style="width:15%;display:inline-block;margin-right: 1%;"><button type="button"
          class="btn" onclick="createCourse()">创建课程</button></div>
    </div>
    <div id="table">
      <table class="table table-bordered">
      </table>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" id="modal_id" role="dialog"></div>
  <div class="modal fade" tabindex="-1" id="modal_edit_id" role="dialog"></div>
  <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<script src="js/bootstrap-datetimepicker.min.js"></script>
<script src="js/bootstrap-datetimepicker.zh-CN.js"></script>
  <script src="common/change.js" type="text/javascript"></script>
  <script type="text/javascript">
  //时间变量
  var cur = new Date();//当前日期
  var cyear = cur.getFullYear();//当前年份
  var cmonth = cur.getMonth() + 1;//当前月份
  var cdate = cur.getDate();//当前日
  var cday = cur.getDay();//当前周的第几天
  var current = cur.getTime();//当前时间戳（毫秒）
  var oneDayTime = 24 * 60 * 60 * 1000;//一天的时间戳
  var week = ['一', '二', '三', '四', '五', '六', '日'];//一周的列表
  var times = ['08:00', '09:00', '10:00', '11:00', '12:00', '14:00', '15:00', '16:00', '17:00'];//日期表格
  var weekFlag = 0;//相距当前周，0为当前周，-1为前一周，1为后一周
  var roomList = [];
  var roomId = '';
  //加载教室列表
  window.onload = function () {
    //获取时间列表
    //获取教室列表
    function getClassRoom(pageNum) {
      var pageSize = 2;
      ajax('/zqfz/teacher/room/list', { 'page_num': pageNum, 'page_size': pageSize }, function (res) {
        if (!res.result) {
          var select = $("#selectRoom");
          for (var i = 0; i < res.data.list.length; i++) {
            select.append("<option value='" + res.data.list[i].id + "'>" + res.data.list[i].name + "</option>");
            roomList.push(res.data.list[i]);
          }
          if (res.data.list.length >= pageSize) {
            getClassRoom(++pageNum);
          }
          roomId = roomList[0].id;
          $('#selectRoom').selectpicker('val', $("#selectRoom option:first-child").val());
          $("input[name='selectId']").val(roomList[0].id);
          $('#selectRoom').selectpicker('render');
          $('#selectRoom').selectpicker('refresh');
        } else {
          alert(res.message);
        }
      }
      );
      // roomId =roomList[0].id;
    }
    $('#selectRoom').selectpicker({ width: '58%' });
    $('input[name="selectId"]').val($("#selectRoom option:first-child").val());
    getClassRoom(1);
    $("#selectRoom").selectpicker({
      noneSelectedText: '请选择'
    });
    $('#selectRoom').on('changed.bs.select', function (e) {
      $('input[name="selectId"]').val($('#selectRoom').selectpicker('val'));
      roomId = $('#selectRoom').selectpicker('val');
      time('');
    });
    time('');
    //首页创建课程弹框出现
    var flag = $.getUrlParam('add');
    if (flag == 2) {
      // popModal('#modal_id', 'createcourse.html');
      createCourse();
    }
  }
    $('#firstnav').find('a[href="timetable.html"]').closest('li').addClass('active');
    //获取课程列表
    function getCourse(pageNum, f) {
      var pageSize = 10;
      ajax('/zqfz/teacher/course/list', { 'page_num': pageNum, 'page_size': pageSize }, function (res) {
        if (!res.result) {
          var select = $("#courseSelect");
          if (f == 1) {
            select = $("#ecourseSelect");
          }
          for (var i = 0; i < res.data.list.length; i++) {
            select.append("<option value='" + res.data.list[i].id + "'>" + res.data.list[i].name + "(" + res.data.list[i].room_name + ")</option>");
          }
          if (res.data.list.length >= pageSize) {
            getCourse(++pageNum);
          }
          select.selectpicker('render');
          select.selectpicker('refresh');
        } else {
          alert(res.message);
        }
      }
      );
    }
    //获取医生列表
    function getDoctor(pageNum, f) {
      var pageSize = 10;
      ajax('/zqfz/teacher/teacher/list', { 'page_num': pageNum, 'page_size': pageSize }, function (res) {
        if (!res.result) {
          var select = $("#doctorSelect");
          if (f == 1) {
            select = $("#edoctorSelect");
          }
          for (var i = 0; i < res.data.list.length; i++) {
            select.append("<option value='" + res.data.list[i].id + "'>" + res.data.list[i].name + "</option>");
          }
          if (res.data.list.length >= pageSize) {
            getDoctor(++pageNum);
          }
          select.selectpicker('render');
          select.selectpicker('refresh');
        } else {
          alert(res.message);
        }
      }
      );
    }
    // //创建信息的提交
    // function createSubmit() {
    //   var courseId = $('input[name="courseId"]').val();
    //   var doctorId = $('input[name="doctorId"]').val();
    //   var babyId = $('input[name="babyId"]').val();
    // }
    // //编辑信息的提交
    // function editSubmit() {
    //   var courseId = $('input[name="courseId"]').val();
    //   var doctorId = $('input[name="doctorId"]').val();
    //   var babyId = $('input[name="babyId"]').val();
    // }
  </script>
</body>
<script type="text/javascript">
  
  // 时间表格的创建
  function timeTable() {
    $('#table table').empty();
    var thead = $("<thead><tr id='head' style='width:100%;'><td style='width: 2%;'></td></tr></thead>");
    $('.table').append(thead);
    var tbody = $("<tbody></tbody>");
    $('.table').append(tbody);

    //左边时间展示
    for (var i = 0; i < times.length; i++) {
      var tr = null;
      if (i != 4) {
        if(i<2){
          tr = $('<tr style="width:100%;"><td style="width: 2%;">' + times[i].substr(1,6) + '</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>');
        }else{
          tr = $('<tr style="width:100%;"><td style="width: 2%;">' + times[i]+ '</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>');
       
        }
     } else {
        tr = $('<tr class="center" style="width:100%;"><td style="width: 2%;">' + times[i] + '</td><td colspan="7" style="background:#fff;">中午休息</td></tr>');
      }
      $('.table tbody').append(tr);
    }
    //上方周期展示
    for (var i = 1; i <= week.length; i++) {
      var td = $("<td></td>");
      $('#head').append(td);
    }
  }
  function time(index) {
    var flag = index || '';
    $('#table div').remove();
    var t = null;
    if (flag == '-') {
      weekFlag = weekFlag - 1;
      current -= 7 * oneDayTime;
    }
    if (flag == '+') {
      weekFlag = weekFlag + 1;
      current += 7 * oneDayTime;
    }
    t = new Date(current);
    // var time=new Date(); 
    var year = t.getFullYear();
    var month = t.getMonth() + 1;
    var date = t.getDate();
    var day = t.getDay();
    $('#ym').text(year + '年' + month + '月' + date + '日');
    timeTable();

    //获取课时列表
    var timearr = $.getWeekStartAndEnd(weekFlag);
    var start = $.dateToUnix(timearr[0]);
    var end = $.dateToUnix(timearr[1])+24*60*60;
    console.log(start+"--"+end);
    //获取一周的信息列表
    console.log($("input[name='selectId']").val());
    ajax('/zqfz/teacher/course-time/list', { 'start_time': start, 'end_time': end, 'room_id': $("input[name='selectId']").val() || $("#selectRoom option:first-child").val() }, function (res) {
      if (res.result) {
        confirm(res.message);
      } else {
        console.log(res.data.list);
        //列表展示一周的信息
        var days = day;
        if (days == 0) {
          days = 7;
        }
        for (var i = 1; i <= week.length; i++) {
          var unixTime = current - (days - i) * oneDayTime;//毫秒
          $('#head').find('td').eq(i).html(week[i - 1] + "  " + dateFormat(unixTime));
          for (var j = 0; j < $('tbody').find('tr').size(); j++) {
            if(j!=4){
            if (month == cmonth && date == cdate) {
              $('#table tbody').find('tr').eq(j).find('td').eq(days).css('background', '#F5FCFF');
            } else {

              $('#table tbody').find('tr').eq(j).find('td').eq(days).css('background', '#FFF');
            }
            }
          }
          //一周的信息遍历展示
          $.each(res.data.list, function (i, item) {
            var dayTime = ($.unixToDate(unixTime / 1000, true)).split(' ');
            //判断是哪一天的信息
            if (i == dayTime[0]) {
              //遍历该天所有课程
              for (var f = 0; f < item.length; f++) {
                //每节课开始时间
                var courseStartTime = ($.unixToDate(item[f].start_time, true)).split(' ');
                //每节课结束时间
                var courseEndTime = ($.unixToDate(item[f].end_time, true)).split(' ');
                var daydd = (new Date(item[f].start_time * 1000)).getDay();
                //每节课所在位置
                for (var k = 0; k < times.length; k++) {
                  //判断该节课所在时段
                  if (courseStartTime[1].substring(0, 2) == times[k].substring(0, 2)) {
                    var height = courseEndTime[1].substring(3, 5) * 3 / 2;
                    var currentTime = (new Date()).getTime();
                    var div = '';
                    if (currentTime / 1000 < item[f].start_time) {
                      div = $("<div class='table-info' onclick='edits(" + item[f].id + ")'><p>" + item[f].course_name + "(" + item[f].classroom_name + ")</p><p>" + item[f].teacher_name + "</p><p>" + item[f].time_desc + "</p><p>" + item[f].baby_count + "</p></div>");
                    } else {
                      div = $("<div class='table-info'><p>" + item[f].course_name + "(" + item[f].classroom_name + ")</p><p>" + item[f].teacher_name + "</p><p>" + item[f].time_desc + "</p><p>" + item[f].baby_count + "</p></div>");
                    }
                    div.attr('id', 'data_' + daydd + '_' + k);
                    if (k > 4) {
                      div.css('top', (k - 1) * 90 + 105);
                    } else {
                      div.css('top', k * 90 + 50);
                    }
                    if(daydd==0){
                      daydd =7;
                    }
                    var per = ((daydd - 1) * 13.7 + 4.4).toFixed(2) + '%';
                    div.css('left', per);
                    div.css('height', height);
                    $("#table").append(div);
                  }
                }
              }
            }
          });
        }
      }
    });
  }
  function dateFormat(Time) {
    //day表示当前星期，index表示一周中的第几天
    // var Time = current - (day - index) * oneDayTime;
    var data = new Date(Time);
    var currentData = new Date();
    var index1 = -1;
    if (cur.getTime() < data.getTime()) {
      index1 = data.getDay();
      if (index1 > 0) {
        $('#table tbody tr').each(function () {
          $(this).find('td').eq(index1).on('click', function () {
            createCourse();
          });
        });
      }
    }
    return (data.getMonth() + 1) + '/' + data.getDate();
  }
  //创建课程
  function createCourse() {
    $('#courseSelect').empty();
    $("#doctorSelect").empty();
    $('#modal_edit_id').load('createcourse.html', function () {
      //获取课程列表
      getCourse(1);
      //获取医生列表
      getDoctor(1);
      $("#courseSelect").selectpicker({
        noneSelectedText: '请选择课程'
      });
      $("#courseSelect").selectpicker('val', '');
      $('#courseSelect').on('changed.bs.select', function (e) {
        $('input[name="courseId"]').val($('#courseSelect').selectpicker('val'));
        console.log($('#courseSelect').selectpicker('val'));
      });
      $("#doctorSelect").selectpicker({
        noneSelectedText: '请选择医生'
      });
      $("#doctorSelect").selectpicker('val', '');
      $('#doctorSelect').on('changed.bs.select', function (e) {
        $('input[name="doctorId"]').val($('#doctorSelect').selectpicker('val'));
        console.log($('input[name="doctorId"]').val());
      });
      //编辑信息的提交
      $('#modal_edit_id').on("shown.bs.modal", function () {
        $('#courseSelect').selectpicker('val', '');
        $('#doctorSelect').selectpicker('val', '');
      })
      //弹出框的激活
      $('#modal_edit_id').modal({ backdrop: 'static' });
    });

  }
  //编辑课程
  function edits(id, event) {
    var info = '';
    ajax('/zqfz/teacher/course-time/detail', { 'id': id }, function (res) {
      if (res.result) {
        confirm(res.message);
      } else {
        info = res.data;
        console.log(id);

        $('#modal_edit_id').load('edittimecourse.html', function () {
          //获取课程列表
          getCourse(1, 1);
          //获取医生列表
          getDoctor(1, 1);
          $("#ecourseSelect").selectpicker({
            noneSelectedText: '请选择课程'
          });
          // $('#ecourseSelect').selectpicker('val', info.course_id);
          $('input[name="ecourseId"]').val(info.course_id);
          $('#ecourseSelect').on('changed.bs.select', function (e) {
            $('input[name="ecourseId"]').val($('#ecourseSelect').selectpicker('val'));
          });
          $("#edoctorSelect").selectpicker({
            noneSelectedText: '请选择医生'
          });
          // $('#edoctorSelect').selectpicker('val', info.teacher_id);
          $('input[name="edoctorId"]').val(info.teacher_id);
          $('#edoctorSelect').on('changed.bs.select', function (e) {
            $('input[name="edoctorId"]').val($('#edoctorSelect').selectpicker('val'));
          });
          $('input[name="eid"]').val(info.id);
          $('input[name="eschedule"]').val(info.schedule_id);
          $('input[name="edate1"]').val(info.start_time);
          $('input[name="edate2"]').val(info.end_time);
          $('input[name="estart"]').val(info.start_time);
          $('input[name="eend"]').val(info.end_time);
          console.log(  $('input[name="estart"]').val());
          var date = $('input[name="estart"]').val();
        console.log($('input[name="estart"]').val()+'----');
        // $('input[name="edate1"]').val(date);
        $('#edate1').text(showtime(date*1000));
        var edate1 = $.unixToDate(date,true);
        var start = edate1.substr(0,16);
   /*日期插件*/
   $('#edatetimepicker1').daterangepicker(
            {
                "singleDatePicker": true,
                "timePicker": true,
                "timePicker24Hour": true,
                "autoApply": true,
                "startDate":start,
                minDate: new Date(),    //最小时间
                "locale": {
                    "direction": "ltr",
                    "format": "YYYY-MM-DD HH:mm",
                    "separator": " - ",
                    "applyLabel": "确定",
                    "fromLabel": "From",
                    "toLabel": "To",
                    "customRangeLabel": "Custom",
                    "daysOfWeek": ["日", "一", "二", "三", "四", "五", "六"],
                    "monthNames": ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                    "firstDay": 0
                },
            }, function (start, end, label) {
                var starttime = start.format('YYYY-MM-DD HH:mm');
                var date = new Date(starttime.replace(/-/g, "/")).getTime();
                var endtime = (date.valueOf() + 60 * 60 * 1000) / 1000;
                var end = new Date(endtime * 1000);
                var endNew = $.unixToDate(endtime);
                var new_end = endNew.substr(0, 16);
                // $('.demo-date').val(starttime);
                // $('.demo-dateTwo').val(new_end);
                $('input[name="edate1"]').val(date);
                $('#edate1').text(showtime(date));
                $('#add-btn').css({ background: "#339AFF" });
                // $('#edatetimepicker2').data('daterangepicker').setStartDate(end);
                // $('#edatetimepicker2').data('daterangepicker').setEndDate(end);
            });
        var date2 = $('#ed2').val();
        // $('input[name="edate2"]').val(date2);
        $('#edate2').text(showtime(date2*1000));
        var edate2 = $.unixToDate(date2,true);
        var start2 = edate2.substr(0,16);
        $('#edatetimepicker2').daterangepicker({
            "singleDatePicker": true,
            "timePicker": true,
            "timePicker24Hour": true,
            "autoApply": true,
            "startDate":start2,
            minDate: new Date(),    //最小时间
            "locale": {
                "direction": "ltr",
                "format": "YYYY-MM-DD HH:mm",
                "separator": " - ",
                "applyLabel": "确定",
                "fromLabel": "From",
                "toLabel": "To",
                "customRangeLabel": "Custom",
                "daysOfWeek": ["日", "一", "二", "三", "四", "五", "六"],
                "monthNames": ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                "firstDay": 0
            },
        }, function (start, end, label) {
            var starttime = start.format('YYYY-MM-DD HH:mm');
            var date = new Date(starttime.replace(/-/g, "/")).getTime();
            $('#add-btn').css({ background: "#339AFF" });
            if ($('input[name="edate1"]').val() >= date) {
                confirm('结束时间不能小于开始时间');
                return false;
            } else if (date - $('input[name="edate1"]').val() > 60 * 60 * 1000) {
                confirm('一节课不能超过一个小时');
                return false;
            } else {
                $('input[name="edate2"]').val(date);
                $('#edate2').text(showtime(date));
            }
        });

       
          $('#edoctorSelect').selectpicker('refresh');
          $('#ecourseSelect').selectpicker('refresh');
          //编辑信息的提交
          //弹出框的激活
          $('#modal_edit_id').modal({ backdrop: 'static' });
          $('#modal_edit_id').on("shown.bs.modal", function () {
            $('#ecourseSelect').selectpicker('val', info.course_id);
            $('#edoctorSelect').selectpicker('val', info.teacher_id);
          })
        });
      }
    });


    stopBubbling(event);
  }
  function stopBubbling(e) {
    e = window.event || e;
    if (e.stopPropagation) {
      e.stopPropagation();      //阻止事件 冒泡传播
    } else {
      e.cancelBubble = true;   //ie兼容
    }
  }
</script>

</html>